# Redis持久化

  - Redis提供了不同形式的持久化方式:
    - RDB(Redis DataBase)
    - AOF(Append Of File)
    - No Persistence
    - RDB + AOF
    
## RDB

  - RDB持久化是将当前进程中的数据周期地生成快照保存到硬盘，也称为Snapshot快照，它恢复时是将快照文件直接读到内存里。
  - RDB持久化流程：
    - Redis会单独创建一个子进程来进行持久化，子进程会先将数据写入到一个临时快照文件中，完成后用这个临时文件替换上次持久化好的文件。
  - 触发RDB快照命令：
    - 手动触发：
      - save: 会阻塞Redis服务器进程，直到RDB文件创建完毕为止
        ```
        save 60 1000 // automatically dump the dataset to disk every 60 seconds if at least 1000 keys changed
        ```
      - bgsave: 会创建一个子进程，由子进程来负责创建RDB文件，父进程(即Redis主进程)则继续处理请求。
      - 使用save命令，整个过程都会阻塞服务器，因此save已基本被废弃
    - 自动触发：
      - 在配置文件（redis.conf）中通过save m n，指定当m秒内发生n次变化时，会触发bgsave。
      - 执行shutdown命令时，自动执行rdb持久化
      - flushall: 执行flushall命令，也会产生dump.rdb文件，但里面是空的，无意义。
  - RDB存储路径：
    - RDB文件的存储路径既可以在启动前配置，也可以通过命令动态设定
    - 配置：dir配置指定目录，dbfilename指定文件名。默认是Redis根目录下的dump.rdb文件。
    - Redis启动后也可以动态修改RDB存储路径，在磁盘损害或空间不足时非常有用；执行命令为config set dir {newdir}和config set dbfilename {newFileName}
  - RDB文件加载：
    - RDB文件的载入工作是在服务器启动时自动执行的，但是由于AOF的优先级更高，因此当AOF开启时，Redis会优先载入AOF文件来恢复数据
    - 服务器载入RDB文件期间处于阻塞状态，直到载入完成为止
  - RDB的恢复：
    - 关闭Redis
    - 把备份的文件拷贝到工作目录下
    - 启动Redis, 备份数据会自动加载
  - RDB优点：
    - 适合备份，可以在事故时恢复数据集的不同版本
    - 适合容灾，单个文件，且RDB文件紧凑，体积小，网络传输快，节省磁盘空间
    - 与AOF相比，RDB最重要的优点之一是性能好，Redis父进程需要做的是创建一个子进程来完成其余持久化的工作，父进程不需要进行磁盘I/O
    - 数据集较大时，恢复速度比AOF快很多
    - 如果对数据完整性和一致性要求不高，可以采用RDB
  - RDB缺点：
    - 做不到实时持久化。由于一定间隔时间做一次备份，如果Redis意外down掉的话，就会丢失最后一次快照后的所有修改。
    - RDB文件需要满足特定格式，兼容性差
    
## AOF

  - 以日志的形式来记录服务端接收的每个写操作，将Redis执行过的所有写指令记录下来(读操作不记录)，只许追加文件但不可以改写文件。
  - 当Redis重启时再次执行AOF文件中的命令来恢复数据。
  - AOF默认保存文件是appendonly.aof。
  - AOF配置：
    - Redis服务器默认开启RDB，关闭AOF；要开启AOF，需要在配置文件中配置：appendonly yes
  - 执行流程：
    - 命令追加(append)：将Redis的写命令追加到缓冲区aof_buf
    - 文件写入(write)和文件同步(sync)：根据不同的同步策略将aof_buf中的内容同步到硬盘
    - 文件重写(rewrite)：定期重写AOF文件，达到压缩的目的
  - AOF同步策略：
    - appendfsync always: 始终同步，每次Redis的写入都会立刻记入日志，硬盘IO成为性能瓶颈，Redis只能支持大约几百TPS写入，严重降低了Redis的性能
    - appendfsync everysec：每秒同步记入日志一次，如果宕机，本秒的数据可能丢失。
    - appendfsync no：从不同步。同步由操作系统负责，通常同步周期为30秒。但实际文件同步的时间不可控，且缓冲区中堆积的数据会很多，数据安全性无法保证。
    - 建议使用appendfsync everysec策略，always策略实际使用时非常慢，no策略不可控
  - AOF重写机制： 
    - Redis服务器执行的写命令越来越多，AOF文件也会越来越大；过大的AOF文件不仅会影响服务器的正常运行，也会导致数据恢复的时间过长。
    - 文件重写是指定期重写AOF文件，减小AOF文件的体积。这是一个安全的过程，因为新增的写命令继续写入到旧的文件，新的AOF文件只保存能够重建当前数据集的最少操作命令集。当新的文件准备好，新的命令会追加到新文件中
    - 文件重写之所以能够压缩AOF文件，原因在于：
      - 过期的数据不再写入文件
      - 无效的命令不再写入文件
      - 多条命令可以合并为一个
    - 由于重写后AOF执行的命令减少了，文件重写既可以减少文件占用的空间，也可以加快恢复速度。
  - AOF的恢复：
    - 将有数据的aof文件复制一份保存到对应目录(config get dir)。
    - 重启Redis重新加载。
  - AOF被截断不完整的做法：
    - 当AOF最后的命令出现截断不完整时，最新的Redis版本依然可以加载AOF文件，只是丢弃最后的格式不完整的命令
  - AOF损坏文件的修复：
    - 先运行redis-check-aof命令，了解出现的问题原因，跳到指定的那一行查看是否能手动修复
    - 不能手动修复则使用redis-check-aof --fix进行修复，这会导致出问题的地方到文件末尾的部分可能被丢弃，因此如果文件损坏发生在文件初始部分则可能会有大量数据丢失
  - AOF优点：
    - 支持秒级持久化、数据的完整性和一致性更高
    - AOF日志是追加形式，没有查找操作，也没有数据损坏问题。即使文件末尾存在只写入一半的命令，redis-check-aof工具可以解决这个问题
    - 当AOF日志文件过大时，后台可以自动重写日志文件
    - AOF文件记录操作的格式容易理解和解析
  - AOF缺点：
    - 文件大，比起RDB占用更多的磁盘空间。
    - 恢复备份速度慢，对性能影响大。
  
## RDB和AOF对比

  - 官方推荐两个都启用。
  - 如果对数据不敏感，可以允许在事故时几分钟的数据丢失，可以选单独用RDB。
  - 如果同时开启两种方式，当Redis重启的时候会优先载入AOF文件来恢复原始的数据,因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整。
    
## 备份数据

  - Redis对于备份数据比较友好，可以在数据库运行时拷贝RDB文件
    - RDB一旦生成不会被修改，并且生成时使用临时的名字，当新的快照完成时会自动重命名为最终的文件名
    - 建议的备份RDB数据流程：
      - 创建一个定时任务，在一个目录创建RDB文件每小时的快照，另一个目录创建每天的快照
      - 每次运行定时脚本时，使用find命令确保很早之前的快照被删除了，可以使用数据和时间信息给快照命名
      - 每天至少一次将RDB快照移动到数据中心外部，或者至少移动到运行当前Redis实例的物理机外部
  - 如果只使用AOF的持久化方式，也可以拷贝AOF文件来备份。AOF可能会缺少最后的部分，但Redis依然可以加载这个文件
  
## 参考

  - https://redis.io/topics/persistence
