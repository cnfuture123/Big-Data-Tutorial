# Redis主从复制

  - 主从复制，就是主机数据更新后根据配置和策略，自动同步到备机的master/slaver机制，Master以写为主，Slave以读为主。
  - 数据的复制是单向的，只能由主节点到从节点
  
## 主从复制相关概念

  - 主从复制作用：
    - 数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式
    - 故障恢复：当主节点出现问题时，可以由从节点提供服务
    - 负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务
  - 建立主从复制的方式：
    - 主从复制的开启，完全是在从节点发起的，不需要我们在主节点做任何事情。
    - 3种方式：
      - 配置文件：在从服务器的配置文件中加入：slaveof masterip masterport
      - 启动命令：redis-server启动命令后加入 --slaveof masterip masterport
      - 客户端命令：Redis服务器启动后，直接通过客户端执行命令：slaveof masterip masterport，则该Redis实例成为从节点。
  - 断开复制关系：
    - 从节点执行slaveof no one命令
    - 从节点断开复制后，不会删除已有的数据，只是不再接受主节点新的数据变化
  - 常用命令：
    - info replication: 打印主从复制的相关信息。
    - slaveof <masterip> <masterport> : 成为某个实例的从服务器。
  - 主从复制原理：
    - 建立连接阶段：
      - 从节点服务器内部维护了两个字段，即masterhost和masterport字段，用于存储主节点的ip和port信息
      - 从节点和主节点建立socket连接，负责后续的复制工作。
    - 数据同步阶段：
      - 从节点向主节点发送psync命令（Redis2.8以前是sync命令），开始同步。到了这一阶段及以后，主从节点互为客户端
      - 数据同步阶段是主从复制最核心的阶段，根据主从节点当前状态的不同，可以分为全量复制和部分复制。
         - 全量复制：主节点中的所有数据都发送给从节点，是一个非常重型的操作。
         - 增量复制：用于网络中断等情况后的复制，只将中断期间主节点执行的写命令发送给从节点
    - 命令传播阶段：
      - 主节点将自己执行的写命令发送给从节点，从节点接收命令并执行，从而保证主从节点数据的一致性。
      - 命令传播是异步的过程，即主节点发送写命令后并不会等待从节点的回复；因此实际上主从节点之间很难保持实时的一致性，延迟在所难免。
  - 常用的配置模式：
    - 一主二仆：
      - 一个Master两个Slave
      
      ![一主二仆](./图片/一主二仆.PNG)
      
    - 薪火相传：
      - 上一个slave可以是下一个slave的Master，slave同样可以接收其他slaves的连接和同步请求。
      - 那么该slave作为了链条中下一个的master, 可以有效减轻master的写压力,去中心化降低风险。
      - 中途变更转向:会清除之前的数据，重新建立拷贝最新的。
      - 风险是一旦某个slave宕机，后面的slave都没法备份。
      
      ![薪火相传](./图片/薪火相传.PNG)
      
    - 反客为主：
      - 当一个master宕机后，后面的slave可以立刻升为master，其后面的slave不用做任何修改。
      - slaveof no one : 使当前数据库停止与其他数据库的同步，转成主数据库。
      
    - 哨兵模式：
      - 反客为主的自动版，能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库。
      - 故障恢复：
        - Sentinel之间进行选举，在剩余活着的机器里选举出一个leader，由选举出的leader进行failover（故障迁移）。
        - Sentinel leader选取slave节点中的一个slave作为新的Master节点。
        - Sentinel leader会在上一步选举的新master上执行slaveof no one操作，将其提升为master节点。
        - Sentinel leader向其它slave发送命令，让剩余的slave成为新的master节点的slave。
        - Sentinel leader会让原来的master降级为slave，当其恢复正常工作。
        - Sentinel leader会发送命令让其从新的master进行复制。上述的failover操作均由sentinel自己独自完成，完全无需人工干预。
      - 选取新master的方式：
        - 选择优先级靠前的，由slave-priority设置优先级。
        - 选择偏移量最大的，即已经复制数据量最大的从节点。
        - 选择runid最小的从服务，每个Redis实例启动后都会随机生成一个40位的runid。
      
      ![哨兵模式](./图片/哨兵模式.PNG)
      


      
