## 复制

  - 概述：
    - 复制使一个MySQL数据库的数据可以拷贝到另一个/多个MySQL数据库
    - MySQL复制的优点：
      - 横向扩展的解决方案：
        - 在多个副本之间分散负载以提高性能
        - 在环境中，所有的写和更新由一个源服务器处理，然而读发生在一个或多个副本；这样可以提高的写的性能，同时随着副本数的增加可以显著提高读的性能
      - 数据安全：
        - 因为副本会暂停复制过程，可以在副本上运行备份服务而不会损坏源数据
      - 数据分析：
        - 在源数据上创建实时数据，在副本上进行分析而不会影响源数据的性能
      - 远距离数据分布：
        - 可以使用复制创建数据的本地副本供远程站点使用，而无需永久访问源服务器
    - MySQL 8.0支持不同的复制方式：
      - 传统方式是基于源服务器的二进制日志，并要求日志文件及其中的位置在源和副本之间同步
      - 新的方式是基于全局事务标识符（GTIDs），使用GTID进行复制可保证源和副本之间的一致性，只要在源上提交的所有事务也已应用于副本
    - 有2种主要的复制格式：
      - 基于语句复制（SBR）：复制整个SQL语句
      - 基于行复制（RBR）：只复制修改的行
  - 配置副本：
    - 基于二进制日志文件位置的副本：
      - 基于二进制日志文件的方式中MySQL实例作为源服务器，将更新操作作为事件写入二进制日志文件，配置的副本读取源服务器的二进制日志，然后在副本本地的数据库执行二进制日志中的语句
      - 每个副本都接收二进制日志的全部内容的拷贝，副本负责决定应执行二进制日志中的哪些语句；如果不指定则执行二进制日志的所有语句
      - 每个副本都保留二进制日志坐标的记录：文件名和从源读取和处理的的位置。因此多个副本可以连接到源服务器，并执行同一个二进制日志中的不同部分
      - 源和副本都需要配置一个唯一ID，此外每个副本要配置源的主机名，日志文件名以及文件中的位置
    - 基于全局事务标识符（GTID）的副本：
      - 概述：
        - 每个事务在提交到源服务器上的时候可以被识别和跟踪，并应用到任意的副本，这种方式不需要使用二进制日志以及文件中的位置
        - GTID的方式是基于事务的，可以简单地确认源和副本是否是一致的，只要提交到源的所有事务也提交到副本，两者之间即是一致的
      - GTID格式和存储：
        - 全局事务标识符是每个事务提交到源服务器上时生成的唯一标识符，这个标识符在复制拓扑结构中都是唯一的
        - 复制的事务保留和分配给源事务的GTID，MySQL系统表mysql.gtid_executed用于保存所有事务分配的GTIDs
        - GTIDs的自动忽略功能指的是源提交的事务在副本上不会应用超过一次，在某个服务器上提交具有给定GTID的事务后，该服务器将忽略任何使用相同GTID执行后续事务
        - GTID表示为一对坐标，用冒号字符分隔：
          ```
          GTID = source_id:transaction_id
          ```
          - source_id用于识别源服务器
          - transaction_id是由事务在源上提交的顺序确定的序列号
        - GTID集合：
          - 一个GTID集合是包含一个或多个GTIDs或一个范围内的GTIDs
          - 示例：
            ```
            3E11FA47-71CA-11E1-9E33-C80AA9429562:1-5
            ```
      - GTID生命周期：
        - 一个事务被执行并提交到源服务器，这个事务被分配一个GTID；GTID被写入源的二进制日志
        - 如果GTID被分配给事务，这个GTID在事务开始时通过写入到二进制日志的方式进行原子性的持久化
        - 在二进制日志数据传递给副本，并存储在副本的中继日志中；副本读取GTID，并将其gtid_next系统变量的值设置为此GTID，这表明副本必须使用此GTID记录下一个事务
        - 副本验证gtid_next中尚未有线程获得GTID的所有权以处理事务
        - 如果尚未使用GTID，则副本将应用复制的事务
        - 如果副本上开启了二进制日志，GTID在提交时自动持久化到二进制日志；如果没有启用，则GTID自动持久化到mysql.gtid_executed表
