# ElasticSearch相关概念

  - Elasticsearch是面向文档(document oriented)的，这意味着它可以存储整个对象或文档(document)。
  - 当文档被存储之后，它可以在1秒之内，近实时地被索引和搜索。
  - ES使用倒排索引的数据结构，支持快速的全文检索
  - ES默认会对每一个属性进行索引，并且每个被索引的属性都有一个专门的，优化的数据结构。例如：text属性是倒排结构，numeric属性是BKD树
  - 在Elasticsearch中，你可以对文档（而非成行成列的数据）进行索引、搜索、排序、过滤。
  - ES与传统数据库的关系：
    ``` 
      Relational DB ‐> Databases ‐> Tables ‐> Rows      ‐> Columns
      ElasticSearch ‐> Index     ‐> Types  ‐> Documents ‐> Fields
    ```
    
## ElasticSearch核心概念

  - Index(索引)
    - 一个索引就是一个拥有相似特征的文档的集合。
    - 一个索引由一个名字来标识（必须全部是小写字母的），并且当我们要对对应于这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字。
    - 在一个集群中，可以定义任意多的索引。
  - Type(类型)
    - 在一个索引中，你可以定义一种或多种类型。
    - 一个类型是索引的一个逻辑上的分类/分区。
    - 通常，会为具有一组共同字段的文档定义一个类型。
  - Document(文档)
    - 一个文档是一个可被索引的基础信息单元。
    - 文档以JSON格式来表示。
    - 在一个index/type里面，你可以存储任意多的文档。
  - Field(字段)
    - 相当于是数据表的字段。
    - key-value pairs
  - Mapping(映射)
    - Mapping是对处理数据的方式和规则方面做一些限制，如某个字段的数据类型、默认值、分析器、是否被索引等。
  - NRT(接近实时)
    - Elasticsearch是一个接近实时的搜索平台，从索引一个文档直到这个文档能够被搜索到有一个轻微的延迟（通常是1秒以内）。
  - Cluster(集群)
    - 一个集群就是由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能。
    - 一个集群由一个唯一的名字标识，这个名字默认就是“elasticsearch”。这个名字很重要，因为一个节点只能通过指定某个集群的名字，来加入这个集群。
    - ES会自动将数据和查询负载分布到可用的节点上
  - Node(节点)
    - 一个节点是集群中的一个服务器，作为集群的一部分，它存储数据，参与集群的索引和搜索功能。
    - 一个节点也是由一个名字来标识的，通过节点名字确定网络中的哪些服务器对应于ElasticSearch集群中的哪些节点。
    - 一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫做“elasticsearch”的集群中。
  - Shards(分片)
    - Elasticsearch提供了将索引划分成多份的能力，这些份就叫做分片。
    - 当你创建一个索引的时候，可以指定分片的数量。
    - 分片的重要性：
      - 允许水平分割/扩展内容容量。
      - 允许在分片（位于多个节点上）之上进行分布式的、并行的操作，进而提高性能/吞吐量。
    - 一个索引实际上是一个或多个分片的逻辑分组，每个分片本身也是一个功能完善并且独立的“索引”。通过将文档分布到同一个索引的多个分片，将分片分布到多个节点上，ES可以保证一定的冗余，既可以在硬件失效时容错，又可以在新节点添加到集群时增加查询容量。当集群伸缩时，ES会自动迁移分片，使集群负载均衡。
    - 分片有2种类型：主分片和复制分片。每个文档属于一个主分片
    - 设置索引主分片的数量和分片大小时需要考虑考虑性能因素：分片越多，维护索引的开销越大；分片越大，移动分片做负载均衡时需要的时间越长。
      - 通常平均的分片大小在几GB和数十GB之间
      - 一个节点能容纳的分片数量正比于可用的堆内存大小，通常每GB堆内存的分片数量应该少于20
  - Replicas(复制)
    - 复制分片是主分片的一个拷贝。
    - 复制分片从不与原/主要（original/primary）分片置于同一节点上。
    - 主分片的数量在索引创建的时候指定，复制分片的数量可以在任意时间更改。
    - 默认情况下，ElasticSearch中的每个索引被分片5个主分片和1个复制分片。
    - 复制分片的重要性：
      - 在分片/节点失败的情况下，提供了高可用性。
      - 增加处理读请求的搜索量/吞吐量。
    
## 索引模块

  - 索引模块是每个索引创建的，并且控制这个索引所有设置
  
### 索引设置

  - 索引设置包含2种：
    - 静态的：在创建索引时设置
      - index.number_of_shards：每个索引的主分片数，默认是1
      - index.number_of_routing_shards：和index.number_of_shards一起使用，路由documents到主分片
    - 动态的：可以通过更新索引的API去修改
      - index.number_of_replicas：每个主分片的复制分片，默认是1
      - index.search.idle.after：分片不能被搜索或请求的搜索空闲时间，默认是30秒
      - index.refresh_interval：多久刷新一次，将最近对索引的修改对搜索和查询可见，默认是1秒，设置为-1会禁用刷新操作。
      - index.max_terms_count：Terms Query中terms数量的最大值，默认是65536
      - index.routing.allocation.enable：控制索引的分配分配
        ![image](https://user-images.githubusercontent.com/46510621/131835485-c0e9a23b-26f2-4af7-935f-9d08fbd78346.png)
      - index.routing.rebalance.enable: 启用分片的负载均衡
        ![image](https://user-images.githubusercontent.com/46510621/131835633-28e9d62c-2e56-4a5a-bf38-91dc577ed334.png)
      - index.routing.allocation.total_shards_per_node：一个节点能分配的最大数量的分片
    
  
