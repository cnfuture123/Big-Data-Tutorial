# 操作案例

## Spring Boot应用

### 排查自动配置问题

  - ApplicationContext中有ConditionEvaluationReport对于自动配置失效的问题十分有用
  - 使用spring-boot-actuator时，也可以通过conditions接口调试应用，查看运行时添加了哪些特性
  - 一些更具体的问题需要查看源码和Javadoc：
    - 搜索*AutoConfiguration类，关注@Conditional*注解，打开debug日志查看应用自动配置的情况
    - 搜索@ConfigurationProperties类，查看可用的外部配置，@ConfigurationProperties注解有一个name属性作为外部配置的前缀
    - 搜索直接绑定到Environment的@Value注解
    - 搜索可以控制特性开关的@ConditionalOnExpression注解

### 创建一个Non-web应用

  - SpringApplication会改变ApplicationContext类，决定是否是一个web应用
  - 对于创建Non-web应用，可以采取以下方式：
    - 将服务器相关的依赖从类路径移除
    - SpringApplication实例显示调用setWebApplicationType(WebApplicationType.NONE)

## 属性和配置

### 构建项目时自动补充属性

  - 如果使用了spring-boot-starter-parent，可以在构建Maven项目时使用@..@占位符自动填充属性
    ```
    app.encoding=@project.build.sourceEncoding@
    app.java.version=@java.version@
    ```
    
### SpringApplication使用外部配置

  - 可以在application.properties文件中设置属性
    ```
    spring.main.web-application-type=none
    spring.main.banner-mode=off
    ```
  - 在外部配置文件中定义的属性会覆盖Java API中的值

### 使用YAML作为外部配置

  - YAML是JSON的超集，可以用层级的格式定义外部属性
    ```
    spring:
      application:
        name: "cruncher"
      datasource:
        driver-class-name: "com.mysql.jdbc.Driver"
        url: "jdbc:mysql://localhost/test"
    server:
      port: 9000
    ```
    
### 设置活跃的Spring Profiles

  - 可以通过以下方式指定活跃的Spring Profiles：
    - 设置系统属性spring.profiles.active
    - 运行应用时通过-D指定：
      ```
      java -jar -Dspring.profiles.active=production demo-0.0.1-SNAPSHOT.jar
      ```
    - 在application.properties中指定：
      ```
      spring.profiles.active=dev
      ```
      
## 嵌入的Web服务器

### 切换Web服务器

  - 在切换HTTP服务器时，需要将默认的依赖替换为所需服务器的依赖
    ```
    <properties>
    <servlet-api.version>3.1.0</servlet-api.version>
    </properties>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
        <exclusions>
            <!-- Exclude the Tomcat dependency -->
            <exclusion>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-tomcat</artifactId>
            </exclusion>
        </exclusions>
    </dependency>
    <!-- Use Jetty instead -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-jetty</artifactId>
    </dependency>
    ```
    
 


